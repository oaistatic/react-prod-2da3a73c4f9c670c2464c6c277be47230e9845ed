import{r as t,c as B,j as d}from"./izh0i1dfnf8ev7x1.js";import{R as k,aa as _,dp as T,bY as W,d as j,b$ as D,P as F,a as L,S as N,cj as P,cn as U}from"./hggowi1ggrzb09yc.js";import{u as A}from"./eru74wmmjzsaepsv.js";import{cL as I,cM as G,fR as O}from"./fc2hzad6rtrm7s5f.js";class V{static async transcribe(r,e){const a=new FormData;return a.append("file",r),e&&a.append("language",e),k.post(`${_}/transcribe`,a)}}const q=48e3,z=10,C=q*z,H=4e3,X=10*60*1e3,m=o=>A.setState(r=>{r.status=o}),$=o=>{const r=t.useRef(o);r.current=o;const e=t.useRef(null),a=t.useRef([]),w=t.useRef(null),v=t.useRef(null),i=t.useRef(null),s=t.useRef(new Float32Array(0)),f=t.useRef(null),n=t.useCallback(()=>{s.current=new Float32Array,r.current.onWaveformDataUpdate(void 0)},[]),c=t.useCallback(async u=>{m("transcribing");try{const h=await V.transcribe(new File([u],"whisper.mp3",{type:"audio/mpeg-3"}));m("idle"),r.current.onSuccess(h.text),n()}catch{m("error"),n()}},[n]),p=t.useCallback(u=>{f.current!==null&&(clearTimeout(f.current),f.current=null),u&&e.current&&(e.current.ondataavailable=null,e.current.onstop=null,m("idle"),n()),e.current?.stop(),e.current?.stream.getTracks().forEach(h=>h.stop()),e.current=null,i.current?.disconnect(),i.current=null,v.current?.disconnect(),v.current=null,w.current?.close(),w.current=null},[n]),y=t.useCallback(()=>{n(),m("recording"),navigator.mediaDevices.getUserMedia({audio:{sampleRate:H,channelCount:1}}).then(u=>{e.current=new MediaRecorder(u),T()?(a.current=[],e.current.ondataavailable=l=>{l.data.size>0&&a.current.push(l.data)},e.current.onstop=async()=>{const l=new Blob(a.current,{type:"audio/mpeg-3"});await c(l)},e.current.start(1e3)):(e.current.ondataavailable=async l=>{await c(l.data)},e.current.start()),s.current=new Float32Array(C).fill(r.current.initialValue),r.current.onWaveformDataUpdate(s.current),m("recording"),f.current=window.setTimeout(()=>{p()},X);const R=new AudioContext;w.current=R;const g=R.createMediaStreamSource(u);v.current=g;const E=R.createScriptProcessor(2048,1,1);i.current=E,E.onaudioprocess=l=>{const x=l.inputBuffer.getChannelData(0);for(let S=0;S<x.length;S++)x[S]=Math.max(x[S],r.current.initialValue);const M=s.current,b=new Float32Array(M.length+x.length);if(b.set(M,0),b.set(x,M.length),b.length>C){const S=b.length-C;s.current=b.slice(S)}else s.current=b;r.current.onWaveformDataUpdate(s.current)},g.connect(E),E.connect(R.destination)}).catch(()=>{m("error"),n()})},[n,p,c]);return t.useEffect(()=>()=>{p(!0)},[p]),{startRecording:y,stopRecording:p}};function Q({disabled:o=!1,size:r="small",initialValue:e,onSuccess:a,onWaveformDataUpdate:w,onExit:v}){const i=B(),s=A(g=>g.status),f=t.useRef(!1),{startRecording:n,stopRecording:c}=$({onSuccess:a,onWaveformDataUpdate:w,initialValue:e});t.useEffect(()=>{const g=()=>{document.hidden&&c()};return window.addEventListener("visibilitychange",g),()=>{window.removeEventListener("visibilitychange",g),c()}},[c]),t.useEffect(()=>{f.current||(n(),f.current=!0)},[n]);const p=d.jsx("div",{children:d.jsx(W,{"aria-label":i.formatMessage({id:"RMraLB",defaultMessage:"Stop dictation"}),size:r,type:"button",onClick:()=>{c(!0),v()},disabled:o||s==="transcribing",style:{viewTransitionName:"--vt-composer-whisper-button"},className:j(I,o?"opacity-30":G),children:d.jsx(D,{"aria-label":i.formatMessage({id:"DFGZS4",defaultMessage:"Stop dictation"}),className:"h-[18px] w-[18px] text-black dark:text-white",fontSize:"inherit"})})}),y=s==="transcribing",u=y?d.jsx(P,{}):d.jsx(U,{className:"icon-lg"}),h=y?i.formatMessage({id:"CyAAys",defaultMessage:"Transcribing dictation"}):i.formatMessage({id:"fcPx42",defaultMessage:"Submit dictation"}),R=d.jsx("div",{children:d.jsx("button",{type:"button","aria-label":h,className:O,onClick:()=>{F.logEvent(L.composerWhisperButtonClickedEnd),N.logEvent("chatgpt_composer_whisper_button_clicked_end"),c()},children:u})});return d.jsxs("div",{className:"flex gap-x-1.5",children:[p,R]})}export{Q as WhisperModeControls};
//# sourceMappingURL=hl2nc0cz1ytov8vn.js.map
