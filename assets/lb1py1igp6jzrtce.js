import{P as Ie,a as Ee,$ as we,n as A,Z as ke,gf as Oe,aH as _e,gg as be,dk as Ae,R as ve,b,aW as Ue,aX as Te,aV as ze,aU as He,D as ce,cu as De,fu as $e,a2 as Ve,H as Be,r as J,gh as We,aK as Ge,I as je,F as Qe,aS as Ke,ao as Se,O as Je,aL as le,d2 as Xe,s as Ce,U as X,aR as ge,gi as Ze,gj as Ye,fF as et,gk as tt,gl as ot}from"./hggowi1ggrzb09yc.js";import{fS as me,fT as Ne,fU as nt,fV as st,ez as Pe,fW as se,fX as ue,fY as it,fZ as Me,f_ as rt,f$ as at,i as dt,a3 as ct,V as lt,g0 as Re,g1 as gt,g2 as ut,a2 as _t,g3 as mt,g4 as ft,as as pt,g5 as ht,g6 as yt,g7 as vt,g8 as Tt,g9 as St,ga as Ct,gb as Mt,ex as Rt,gc as It,gd as Et}from"./fc2hzad6rtrm7s5f.js";import{a as wt,d as kt,r as Ot}from"./izh0i1dfnf8ev7x1.js";import{T as bt}from"./8nxoaz0vb9p890un.js";const At="OAI-Echo-Logs",H={FOCUS_IN:0,FOCUS_OUT:1,COPY:2,PASTE:3,TOUCH_START:4,TOUCH_END:5},xe=[];function D(e){return()=>{xe.push({type:e,ts:Math.round(performance.now())})}}const Nt={focusin:D(H.FOCUS_IN),focusout:D(H.FOCUS_OUT),copy:D(H.COPY),paste:D(H.PASTE),touchstart:D(H.TOUCH_START),touchend:D(H.TOUCH_END)};function Kt(e){const t=e??document.getElementById(bt);for(const[s,d]of Object.entries(Nt))t?.removeEventListener(s,d),t?.addEventListener(s,d)}function Fe(){return{[At]:xe.slice(0,10).map(e=>`${e.type},${e.ts}`).join(",")}}function Pt(e,t,s,d,c){const u=Lt(e,t,s,c);return Ft(s,d,u)}const xt=1e3*30,Z=me.getTracer("completion");async function*Ft(e,t,s){let d=!1,c=!1,u=!1,p=!1,T,h,m,f,y;Z.startActiveSpan("completion.response",a=>{T=Z.startSpan("completion.first_response"),h=Z.startSpan("completion.first_token_including_tool_calls"),m=Z.startSpan("completion.first_token_including_visible_content"),f=Z.startSpan("completion.first_token"),y=a});let _=setTimeout(()=>{Ie.logEvent(Ee.sseResponseWaitTooLong,{}),e.logCompletion({type:we.Error,error:{reason:"timeout",message:"SSE Response Took Too Long to Come Back"}})},xt);try{t?.logTiming("fetch_event_source");for await(const a of s){if(yield a,a.type==="connected"){t?.logTiming("prompt_submitted");continue}_&&(clearTimeout(_),_=null),a.type==="message"&&(d||(d=!0,T?.end(),t?.logTiming("first_response")),!c&&a.message.author.role===A.Assistant&&(c=!0,h?.end(),t?.logTiming("first_assistant_token")),!u&&a.message.author.role===A.Assistant&&ke(a.message)&&(u=!0,m?.end(),t?.logTiming("first_visible_content_token")),!p&&a.message.author.role===A.Assistant&&Oe(a.message)&&(p=!0,f?.end(),t?.logTiming("first_message_token")))}}catch(a){throw _&&(clearTimeout(_),_=null),a}finally{y?.end()}}async function*Lt(e,t,s,d){let u=`${_e(e)?Ne(3010482349,`${t.model}-AAAA`)?window.location.origin+"/backend-alt":window.location.origin+"/backend-api":window.location.origin+"/backend-anon"}/conversation`;const p=nt(u,{clientSession:e,method:"POST",headers:{...Fe(),...be(t.chatReq,t.turnstileToken,t.proofToken,null),...t.conduitToken?{"x-conduit-token":t.conduitToken}:{}},body:qt(t),intercomEventOnError:"fetch-error:conversation:new-message",signal:d}),T=st(p,m=>{s.stream_encoding=m});let h=!1;for await(const m of T)if("response"in m)yield{type:"connected",serverRequestId:m.response.headers.get("Cf-Ray")??null};else{const f=Ut(m.data);f&&(f.type==="done"&&(h=!0),yield f)}h||(yield{type:"done"})}function qt(e){const t="threadId"in e?e.threadId:void 0;return{action:e.completionType,messages:e.messages.length>0?e.messages:void 0,conversation_id:t,continue_from_shared_conversation_id:"continueFromSharedConversationId"in e&&t==null?e.continueFromSharedConversationId:void 0,parent_message_id:e.parentMessageId,model:e.model,timezone_offset_min:new Date().getTimezoneOffset(),timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,variant_purpose:e.completionMetadata?.variantPurpose,suggestions:e.completionMetadata?.suggestions?e.completionMetadata.suggestions.map(s=>Pe(s)):void 0,chosen_suggestion:e.completionMetadata?.suggestion?{type:e.completionMetadata.suggestion.type,index:e.completionMetadata.suggestionIndex,source:e.completionMetadata.suggestion.type===se.Autocomplete?e.completionMetadata.suggestion.source:void 0,user_input:e.completionMetadata.suggestion.type===se.Autocomplete?e.completionMetadata.suggestion.userInput:void 0}:void 0,history_and_training_disabled:E(e.historyDisabled),conversation_mode:e.completionMetadata?.conversationMode,force_paragen:E(e.forceParagen),force_paragen_model_slug:e.forceParagenModel,force_indepth_feedback:E(e.forceIndepthFeedback),force_rate_limit:E(e.forceRateLimit),reset_rate_limits:E(e.resetRateLimits),record_rendering:E(e.recordRendering),disable_system_content_toggling:E(e.disableSystemContentToggling),enable_message_followups:e.enableMessageFollowups,source:e.completionMetadata?.source,system_hints:e.completionMetadata?.systemHints,prefetch_ids:e.completionMetadata?.prefetchIds,supports_buffering:!0,supported_encodings:[ue.V1],conversation_origin:oe(e.conversationOrigin),force_use_search:oe(e.forceUseSearch),client_reported_search_source:e.completionMetadata?.searchSource,client_contextual_info:e.contextualInfo,paragen_stream_type_override:oe(e.paragenStreamType==="none"?null:e.paragenStreamType),paragen_cot_summary_display_override:oe(e.paragenCotSummaryDisplay==="none"?null:e.paragenCotSummaryDisplay),is_onboarding_conversation:E(e.isOnboardingConversation)}}function E(e){if(e===!0)return e}function oe(e){if(e!=null)return e}function Ut(e){if("type"in e)switch(e.type){case"gizmo_inline_review":return{type:"gizmo_inline_review",gizmoId:e.gizmo_id};case"title_generation":return{type:"title_generation",title:e.title,conversation_id:e.conversation_id};case"moderation":return{type:"moderation",conversationId:e.conversation_id,messageId:e.message_id,isCompletion:e.is_completion,flagged:e.moderation_response.flagged,blocked:e.moderation_response.blocked,disclaimers:e.moderation_response.disclaimers,metadata:e.moderation_response.metadata};case"url_moderation":return{type:"url_moderation",conversationId:e.conversation_id,messageId:e.message_id,url:e.url_moderation_result.full_url,isSafe:e.url_moderation_result.is_safe};case"num_variants_in_stream":return{type:"num_variants_in_stream",num_variants_in_stream:e.num_variants_in_stream,display_treatment:e.display_treatment};case"conversation_detail_metadata":return e;case"message_stream_complete":return{type:"done"};default:return}if(e.message)return{type:"message",message:e.message,conversationId:e.conversation_id}}const zt=1e3*30,Y=me.getTracer("completion");function Ht(e,t,s,d,c){const u=new AbortController,p=c?it([c,u.signal]):u.signal,T="threadId"in t?t.threadId:void 0,h="continueFromSharedConversationId"in t?t.continueFromSharedConversationId:void 0,m=t.model,f={action:t.completionType,messages:t.messages.length>0?t.messages:void 0,conversation_id:T,continue_from_shared_conversation_id:T!=null?void 0:h,parent_message_id:t.parentMessageId,model:t.model,timezone_offset_min:new Date().getTimezoneOffset(),timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,variant_purpose:t.completionMetadata?.variantPurpose,suggestions:t.completionMetadata?.suggestions?t.completionMetadata.suggestions.map(n=>Pe(n)):void 0,chosen_suggestion:t.completionMetadata?.suggestion?{type:t.completionMetadata.suggestion.type,index:t.completionMetadata.suggestionIndex,source:t.completionMetadata.suggestion.type===se.Autocomplete?t.completionMetadata.suggestion.source:void 0,user_input:t.completionMetadata.suggestion.type===se.Autocomplete?t.completionMetadata.suggestion.userInput:void 0}:void 0,history_and_training_disabled:w(t.historyDisabled),conversation_mode:t.completionMetadata?.conversationMode,force_paragen:w(t.forceParagen),force_paragen_model_slug:t.forceParagenModel,force_indepth_feedback:w(t.forceIndepthFeedback),force_rate_limit:w(t.forceRateLimit),record_rendering:w(t.recordRendering),reset_rate_limits:w(t.resetRateLimits),disable_system_content_toggling:w(t.disableSystemContentToggling),enable_message_followups:t.enableMessageFollowups,source:t.completionMetadata?.source,system_hints:t.completionMetadata?.systemHints,prefetch_ids:t.completionMetadata?.prefetchIds,supports_buffering:!0,supported_encodings:[ue.V1],conversation_origin:ne(t.conversationOrigin),force_use_search:ne(t.forceUseSearch),client_reported_search_source:t.completionMetadata?.searchSource,client_contextual_info:t.contextualInfo,paragen_stream_type_override:ne(t.paragenStreamType==="none"?null:t.paragenStreamType),paragen_cot_summary_display_override:ne(t.paragenCotSummaryDisplay==="none"?null:t.paragenCotSummaryDisplay),is_onboarding_conversation:w(t.isOnboardingConversation)};let y,_;const a=Ae(e);_e(a)?(Ne(3010482349,`${m}-AAAA`)?_=window.location.origin+"/backend-alt":_=window.location.origin+"/backend-api",y=ve.getAuthedHeadersWithAccessToken(a.accessToken)):(_=window.location.origin+"/backend-anon",y=ve.getUnauthHeaders().additionalHeaders),t.conduitToken&&(y["x-conduit-token"]=t.conduitToken);let v=`${_}/conversation`;const ie=be(t.chatReq,t.turnstileToken,t.proofToken,null),k={...y,...Fe(),...ie};let ee=!1,$=!1,N=!1,V=!1,P,x,S,B,O;Y.startActiveSpan("completion.response",n=>{P=Y.startSpan("completion.first_response"),x=Y.startSpan("completion.first_token_including_tool_calls"),S=Y.startSpan("completion.first_token_including_visible_content"),B=Y.startSpan("completion.first_token"),O=n});const W=me.setSpan(Me.active(),O);let F=null,G=!1;function L(){G||(G=!0,s({type:"done"}))}function I(n){if(t.turnTracker.onBytesReceived(n.data),n.data==="[DONE]")u.abort(),O.end(),L();else if(n.event!=="ping")try{let o=JSON.parse(n.data);if(n.event==="delta_encoding")if(o===ue.V1)t.turnTracker.stream_encoding=o,F=new at;else{ce.addError(`[completion-delta] unknown delta encoding: ${o}`);return}else if(n.event==="delta"){if(!F){ce.addError("[completion-delta] delta event before delta_encoding");return}o=F.applyDelta(o)}if(o.error){const C=b.createWithErrorMessage(v,"server",o.error);throw s({type:"error",error:C}),C}else"type"in o?o.type==="gizmo_inline_review"?s({type:"gizmo_inline_review",gizmoId:o.gizmo_id}):o.type==="title_generation"?s({type:"title_generation",title:o.title,conversation_id:o.conversation_id}):o.type==="moderation"?s({type:"moderation",conversationId:o.conversation_id,messageId:o.message_id,isCompletion:o.is_completion,flagged:o.moderation_response.flagged,blocked:o.moderation_response.blocked,disclaimers:o.moderation_response.disclaimers,metadata:o.moderation_response.metadata}):o.type==="url_moderation"?s({type:"url_moderation",conversationId:o.conversation_id,messageId:o.message_id,url:o.url_moderation_result.full_url,isSafe:o.url_moderation_result.is_safe}):o.type==="num_variants_in_stream"?s({type:"num_variants_in_stream",num_variants_in_stream:o.num_variants_in_stream,display_treatment:o.display_treatment}):o.type==="conversation_detail_metadata"?s(o):o.type==="message_stream_complete"&&L():(s({type:"message",message:o.message,conversationId:o.conversation_id}),ee||(ee=!0,P.end(),t.profiler?.logTiming("first_response")),!$&&o.message.author.role===A.Assistant&&($=!0,x.end(),t.profiler?.logTiming("first_assistant_token")),!N&&o.message.author.role===A.Assistant&&ke(o.message)&&(N=!0,S.end(),t.profiler?.logTiming("first_visible_content_token")),!V&&o.message.author.role===A.Assistant&&Oe(o.message)&&(V=!0,B.end(),t.profiler?.logTiming("first_message_token")))}catch(o){if(o instanceof b)throw o}}let q=setTimeout(()=>{Ie.logEvent(Ee.sseResponseWaitTooLong,{}),t.turnTracker.logCompletion({type:we.Error,error:{reason:"timeout",message:"SSE Response Took Too Long to Come Back"}})},zt);Me.with(W,()=>(t.profiler?.logTiming("fetch_event_source"),t.turnTracker.onSentUserMessage(),rt(v,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json",...k},body:JSON.stringify(f),signal:p,openWhenHidden:!0,async onopen(n){const o=n.headers.get("content-type")??"",C=n.headers.get("Cf-Ray")??null;if(n.ok&&o.includes("text/event-stream")){d(C,t.model),t.profiler?.logTiming("prompt_submitted");return}else if(o.includes("application/json")){const M=await n.json(),l=new b(v,n.status,M);if(l.isServerError())throw l;if((l.code==="expired_session_key"||l.code==="invalid_api_key"||l.code==="token_expired")&&typeof window<"u"&&window._oaiHandleSessionExpired?.("stream",JSON.stringify(l)),l.code==="deactivated_workspace"){window.location.href.includes("/workspace/deactivated")||(window.location.href="/workspace/deactivated");return}throw l}else{const M=await n.text();throw new b(v,n.status,{detail:{message:Ue,code:"unexpected_content_type",contentType:o,text:M.substring(0,1e3)}})}},onmessage:n=>{q&&(clearTimeout(q),q=null),I(n)},onerror(n){let o=n instanceof Error?n:new Error(JSON.stringify(n));throw o.message==="Failed to fetch"&&(o=b.createWithErrorMessage(v,"server",`An error occurred. Either the engine you requested does not exist or there was another issue processing your request. ${Te}`)),o.message==="network error"&&(o=b.createWithErrorMessage(v,"client",`A network error occurred. Please check your connection and try again. ${Te}`)),ze("fetch-error:conversation:new-message",{url:v,message:o.message}),s({type:"error",error:o}),o}}))).catch(async n=>{n instanceof b?He(n):ce.addError(n),t.turnTracker.handleRawError(n.message??"Something went wrong",n.status)})}function w(e){if(e===!0)return e}function ne(e){if(e!=null)return e}function Jt({clientThreadId:e,preRequestCompletion:t}){const s=wt(),d=De(),c=$e(),u=kt(),p=dt(),T=null,h=ct(e),m=h&&"gizmo"in h?h.gizmo?.gizmo.id:void 0,f=lt(m),y=m?f?Re.PROJECT:Re.GPT:void 0,_=gt(e),{value:a}=Ve("2939275435"),v=ut();return Ot.useCallback(async function({requestedModelId:ie,completionType:k=ge.Next,eventSource:ee="mouse",completionMetadata:$,extraStreamParams:N,promptMessage:V,prependMessages:P,appendMessages:x,profiler:S,conduitToken:B}={}){const O=performance.now(),W=new AbortController,F=Ae(s),G=ot(),L=Be(e),I=`${tt}${e}-${G}`,q=`${e}-${G}`,U=ie??J(e)?.modelId??_t(We(s,c)).id,n=new mt({gizmoType:y,preflightTime:O}),o=i=>{J(i)?.disableConversationNavigation||It(u,s,i,f)};Ge.publish({kind:"requestCompletion"}),t?.(),ft.reset(),pt(e,{source:je.CLIENT,value:Qe.STREAMING}),Ke.addRequest(I,W,n),ht.onCompletionRequestStarted(I),yt.incrementUserMessageCount(_e(F)?Se.LoggedIn:Se.LoggedOut),L===void 0&&Je(e)&&le(e,i=>{i.initialThreadData.lastModelUsed=U}),V&&le(e,i=>{Xe.appendMessage(i,V)});const C=Ce.getCurrentLeafId(J(e)),M=Ce.getTree(J(e));X.retainThread(e);const l=M.getNodeByIdOrMessageId(C);M.getConversationTurns(C,T!=null).length>2&&le(e,i=>{i.scrollToMessageId=l.message.id});const Le={gizmo_id:l.message.metadata?.gizmo_id};X.updateTree(e,i=>{i.addNode(I,"",C,A.Assistant,void 0,Le)}),X.setThreadCurrentLeafId(e,I);let j,R=[],z=M.getNodeByIdOrMessageId(l.parentId);for(;z!=null&&(z.metadata?.isPlaceholderTemplateAssistantWelcomeMessage===!0||z.metadata?.isClientCreatedSystemMessage===!0);){const i=z.message;R.unshift(i);const g=M.getNodeByIdOrMessageId(z.parentId);j=g.message.id??g.id,z=g}if(k===ge.Next||k===ge.Variant){const i=M.getNodeByIdOrMessageId(l.parentId);if(j??=i.message.id??i.id,P){let g=l.parentId,ae=l.id;X.updateTree(e,K=>{for(const de of P)K.insertNodeBefore(ae,{id:de.id,message:de,parentId:g,children:[]}),g=de.id}),R.push(...P)}if(R.push(l.message),x){let g=C;X.updateTree(e,ae=>{for(const K of x)ae.insertNodeBefore(I,{id:K.id,message:K,parentId:g,children:[]}),g=K.id}),R.push(...x)}R=$t(R,N)}else j??=l.message.id;n.onUserMessages(R);const te=J(e);S?.logTiming("start_chat_requirements");const Q=await Ze();S?.logTiming("fetched_chat_requirements"),Q.force_login&&p({authType:"login"});const[fe,pe]=await Promise.all([vt.getEnforcementToken(Q).then(i=>(S?.logTiming("fetched_turnstile_token"),i),i=>null),Ye.getEnforcementToken(Q).then(i=>(S?.logTiming("fetched_p_token"),i),i=>null),s.ensureQueryData(et(c))]);Tt()&&await St();const he=(i,g)=>{n.onStreamOpen(),i&&n.onReceivedRequestId(i),Et(q,g,i,qe)},ye={is_dark_mode:d,time_since_loaded:Math.floor(performance.now()/1e3),page_height:window.innerHeight,page_width:window.innerWidth,pixel_ratio:window.devicePixelRatio,screen_height:window.screen.height,screen_width:window.screen.width},r=Ct(),re=new Mt(s,e,I,k,U,ee,o,q,n,c,O),qe=performance.now()-O;if(a){const i=Pt(F,{conversationOrigin:te?.conversationOrigin??null,model:U,completionType:k,threadId:L,continueFromSharedConversationId:te?.continuingFromSharedConversationId,historyDisabled:c,parentMessageId:j,messages:R,chatReq:Q,turnstileToken:fe,proofToken:pe,conduitToken:B,completionMetadata:$,contextualInfo:ye,isOnboardingConversation:_,forceParagen:r.forceParagen,forceParagenModel:r.forceParagen?r.forceParagenModel.value:void 0,forceRateLimit:r.forceRateLimit,resetRateLimits:r.resetRateLimits,recordRendering:r.recordRendering,disableSystemContentToggling:r.rebaseSystemMessageContent!=null,forceUseSearch:r.forceUseSearch??void 0,paragenStreamType:r.paragenStreamType,paragenCotSummaryDisplay:r.paragenCotSummaryDisplay,...v?{f_completion:!0}:{},...N},n,S,W.signal);try{for await(const g of i)g.type==="connected"?he(g.serverRequestId,U):re.handleResponse(g)}catch(g){re.handleError({type:"error",error:Dt(g)})}}else Ht(s,{conversationOrigin:te?.conversationOrigin??null,model:U,completionType:k,threadId:L,continueFromSharedConversationId:te?.continuingFromSharedConversationId,historyDisabled:c,parentMessageId:j,messages:R,chatReq:Q,turnstileToken:fe,proofToken:pe,completionMetadata:$,turnTracker:n,profiler:S,contextualInfo:ye,isOnboardingConversation:_,conduitToken:B,forceParagen:r.forceParagen,forceParagenModel:r.forceParagen?r.forceParagenModel.value:void 0,forceRateLimit:r.forceRateLimit,recordRendering:r.recordRendering,resetRateLimits:r.resetRateLimits,disableSystemContentToggling:r.rebaseSystemMessageContent!=null,forceUseSearch:r.forceUseSearch??void 0,paragenStreamType:r.paragenStreamType,paragenCotSummaryDisplay:r.paragenCotSummaryDisplay,...v?{f_completion:!0}:{},...N},re.handleResponse,he,W.signal)},[e,s,c,d,T,u,p,y,f,v,t,_,a])}function Dt(e){return e instanceof Error?e:new Error(typeof e=="string"?e:"Something went wrong")}const $t=(e,t)=>{let s=e;return t?.forceUseSearch===!1&&e.length>0&&(s=e.map(d=>{const{system_hints:c,...u}=d.metadata||{};return{...d,metadata:{...u,system_hints:c?.filter(p=>p!==Rt.Search)}}})),s};export{Kt as t,Jt as u};
//# sourceMappingURL=lb1py1igp6jzrtce.js.map
